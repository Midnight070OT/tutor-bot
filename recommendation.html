<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Recommendation</title>
    <style>
        /* Add relevant styles here */
    </style>
</head>
<body>
    <div class="container">
        <h1 id="course-title"></h1>
        <p>Recommended Tutor: <strong id="tutor-name"></strong></p>
        <button onclick="acceptSession()">Accept</button>
        <button onclick="declineSession()">Decline</button>
        <button onclick="markInSession()">In Session</button>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const course = params.get('course');
        const scriptURL = 'https://script.google.com/macros/s/AKfycbx8mHX7iyAVc9hdDlDAh5Rm6pvO_3TXVkH3Hc1uXKFplqrPD8K5GsWjUHb8wGg3TZNQ/exec'; // Replace with your Google Apps Script URL

        document.getElementById('course-title').textContent = `Course: ${course}`;

        function recommendTutor() {
            fetch(`${scriptURL}?function=getTutorsAndCourses`)
                .then(response => response.json())
                .then(data => {
                    const eligibleTutors = data.filter(tutor => tutor.available && tutor.courses.includes(course))
                        .sort((a, b) => a.sessions - b.sessions);
                    
                    if (eligibleTutors.length === 0) {
                        alert(`No more tutors available for ${course}.`);
                        window.history.back();
                        return;
                    }
                    
                    const [recommendedTutor] = eligibleTutors;
                    document.getElementById('tutor-name').textContent = recommendedTutor.tutor;
                })
                .catch(error => console.error("Error recommending tutor:", error));
        }

        function acceptSession() {
            const tutorName = document.getElementById('tutor-name').textContent;
            fetch(`${scriptURL}?function=updateSessionStats&tutorName=${encodeURIComponent(tutorName)}&action=accept`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`${tutorName} accepted the session.`);
                        window.history.back();
                    } else {
                        alert(`Failed to update session for ${tutorName}`);
                    }
                })
                .catch(error => console.error("Error accepting session:", error));
        }

        function declineSession() {
            const tutorName = document.getElementById('tutor-name').textContent.trim();
            fetch(`${scriptURL}?function=updateSessionStats&tutorName=${encodeURIComponent(tutorName)}&action=decline`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`${tutorName} declined the session. Finding another tutor...`);
                        recommendTutor();
                    } else {
                        alert(`Failed to decline session for ${tutorName}`);
                    }
                })
                .catch(error => console.error("Error declining session:", error));
        }

        function markInSession() {
            const tutorName = document.getElementById('tutor-name').textContent;
            fetch(`${scriptURL}?function=updateTutorAvailability&tutorName=${encodeURIComponent(tutorName)}&available=false`, {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`${tutorName} is now in session. Finding another tutor...`);
                        recommendTutor();
                    } else {
                        alert(`Failed to mark ${tutorName} as in session`);
                    }
                })
                .catch(error => console.error("Error marking in session:", error));
        }

        recommendTutor(); // Start by recommending a tutor on page load
    </script>
</body>
</html>
