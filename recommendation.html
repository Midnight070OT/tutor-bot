<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Recommendation</title>
    <style>
        /* Styles omitted for brevity */
    </style>
</head>
<body>
    <div class="container">
        <h1 id="course-title"></h1>
        <p>Recommended Tutor: <strong id="tutor-name"></strong></p>
        <button onclick="acceptSession()">Accept</button>
        <button onclick="declineSession()">Decline</button>
        <button onclick="markInSession()">In Session</button>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const course = params.get('course');
        const url = 'https://script.google.com/macros/s/AKfycbwL_ACWUYtBJDdx0fMaYRfh873GPupwYpNH6YAa8BrQ2tk1PzCj7NEPFuRZGXunqcrP/exec'; // Replace with your actual Google Apps Script URL

        document.getElementById('course-title').textContent = `Course: ${course}`;

        // Function to recommend a tutor for the selected course
        function recommendTutor() {
            fetch(url + "?function=getTutorsAndCourses")
                .then(response => response.json())
                .then(data => {
                    const eligibleTutors = data.filter(tutor => tutor.available && tutor.courses.includes(course))
                        .sort((a, b) => a.sessions - b.sessions);
                    
                    if (eligibleTutors.length === 0) {
                        alert(`No more tutors available for ${course}.`);
                        window.history.back();
                        return;
                    }
                    
                    const [recommendedTutor] = eligibleTutors;
                    document.getElementById('tutor-name').textContent = recommendedTutor.tutor;
                })
                .catch(error => console.error("Error recommending tutor:", error));
        }

        // Accept a session and update the tutor's status
        function acceptSession() {
            const tutorName = document.getElementById('tutor-name').textContent;
            fetch(`${url}?function=updateSessionStats&tutorName=${encodeURIComponent(tutorName)}&action=accept`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`${tutorName} accepted the session.`);
                        window.history.back(); // Return to main page after accepting
                    } else {
                        alert(`Error updating session for ${tutorName}`);
                    }
                })
                .catch(error => console.error("Error accepting session:", error));
        }

        // Decline a session and suggest the next tutor
        function declineSession() {
            const tutorName = document.getElementById('tutor-name').textContent.trim();
            fetch(`${url}?function=updateSessionStats&tutorName=${encodeURIComponent(tutorName)}&action=decline`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`${tutorName} declined the session. Finding another tutor...`);
                        recommendTutor(); // Recommend another tutor
                    } else {
                        alert(`Error declining session for ${tutorName}`);
                    }
                })
                .catch(error => console.error("Error declining session:", error));
        }

        // Mark a tutor as "in session" and update availability
        function markInSession() {
            const tutorName = document.getElementById('tutor-name').textContent;
            fetch(`${url}?function=updateTutorAvailability&tutorName=${encodeURIComponent(tutorName)}&available=false`, {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`${tutorName} is now in session. Finding another tutor...`);
                        recommendTutor(); // Recommend another tutor
                    } else {
                        alert(`Error marking ${tutorName} as in session`);
                    }
                })
                .catch(error => console.error("Error marking in session:", error));
        }

        recommendTutor(); // Start by recommending a tutor on page load
    </script>
</body>
</html>
